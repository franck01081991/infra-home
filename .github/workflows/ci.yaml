name: ci

on:
  pull_request: {}
  push:
    branches:
      - main

env:
  KUSTOMIZE_VERSION: "5.3.0"
  KUBECONFORM_VERSION: "v0.6.7"

permissions:
  contents: read

jobs:
  nix-flake-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05

      - name: Nix flake check
        run: nix flake check --all-systems

  lint-yaml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install yamllint
        run: pip install --upgrade yamllint

      - name: Lint YAML
        run: yamllint --strict .

  kubeconform:
    runs-on: ubuntu-latest
    needs:
      - nix-flake-check
      - lint-yaml
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          set -euo pipefail
          KUSTOMIZE_BASE="https://github.com/kubernetes-sigs/kustomize/releases"
          KUSTOMIZE_URL="${KUSTOMIZE_BASE}/download/kustomize/v${KUSTOMIZE_VERSION}/"
          KUSTOMIZE_URL+="kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          curl -Lo kustomize.tar.gz "${KUSTOMIZE_URL}"
          tar -xzvf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin

      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_URL="https://github.com/yannh/kubeconform/"
          KUBECONFORM_URL+="releases/download/${KUBECONFORM_VERSION}/"
          KUBECONFORM_URL+="kubeconform-linux-amd64.tar.gz"
          curl -L "$KUBECONFORM_URL" | tar -xz kubeconform
          sudo mv kubeconform /usr/local/bin/

      - name: Validate manifests with kubeconform
        run: |
          set -euo pipefail
          SKIP_KINDS="CustomResourceDefinition,HelmRepository,HelmRelease"
          SKIP_KINDS="${SKIP_KINDS},GitRepository,Kustomization,Application"
          SKIP_KINDS="${SKIP_KINDS},SecretStore,ExternalSecret"

          for env in review staging prod; do
            kustomize build "clusters/${env}" \
              | kubeconform -strict \
                --skip "${SKIP_KINDS}" \
                --summary;
          done

  trufflehog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Secret scanning (trufflehog)
        uses: trufflesecurity/trufflehog-actions-scan@v3
        with:
          scanArguments: "--no-update --fail --only-verified --json"

  promote-review:
    runs-on: ubuntu-latest
    needs:
      - kubeconform
      - trufflehog
    environment: review
    steps:
      - name: Await approval for review
        run: echo "Ready to sync review environment via Flux"

  promote-staging:
    runs-on: ubuntu-latest
    needs:
      - promote-review
    environment: staging
    steps:
      - name: Await approval for staging
        run: echo "Ready to promote to staging"

  promote-prod:
    runs-on: ubuntu-latest
    needs:
      - promote-staging
    environment: prod
    steps:
      - name: Await approval for prod
        run: echo "Ready to promote to prod"
