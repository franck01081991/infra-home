---
name: ci

'on':
  pull_request: {}
  push:
    branches:
      - main

env:
  KUSTOMIZE_VERSION: "5.3.0"
  KUBECONFORM_VERSION: "v0.6.7"
  TRIVY_VERSION: "0.55.2"
  KUBE_LINTER_VERSION: "0.7.6"

permissions:
  contents: read

jobs:
  nix-flake-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05

      - name: Nix flake check
        run: nix flake check --all-systems

  kubeconform:
    runs-on: ubuntu-latest
    needs:
      - nix-flake-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          set -euo pipefail
          KUSTOMIZE_URL="https://github.com/kubernetes-sigs/kustomize/releases"
          KUSTOMIZE_URL+="/download/"
          KUSTOMIZE_URL+="kustomize%2Fv${KUSTOMIZE_VERSION}/"
          KUSTOMIZE_URL+="kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          curl -Lo kustomize.tar.gz "$KUSTOMIZE_URL"
          tar -xzvf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin

      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_URL="https://github.com/yannh/kubeconform/"
          KUBECONFORM_URL+="releases/download/${KUBECONFORM_VERSION}/"
          KUBECONFORM_URL+="kubeconform-linux-amd64.tar.gz"
          curl -L "$KUBECONFORM_URL" | tar -xz kubeconform
          sudo mv kubeconform /usr/local/bin/

      - name: Validate manifests with kubeconform
        run: |
          set -euo pipefail
          SKIP_KINDS="CustomResourceDefinition,HelmRepository,HelmRelease"
          SKIP_KINDS="${SKIP_KINDS},GitRepository,Kustomization,Application"
          SKIP_KINDS="${SKIP_KINDS},SecretStore,ExternalSecret"

          for env in review staging prod; do
            kustomize build "clusters/${env}" \
              | kubeconform -strict \
                --skip "${SKIP_KINDS}" \
                --summary;
          done

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run ShellCheck on all shell scripts
        run: |
          find . -name "*.sh" -type f | while read -r script; do
            echo "Checking $script..."
            shellcheck "$script"
          done

  nix-lint:
    runs-on: ubuntu-latest
    env:
      NIX_CONFIG: |
        experimental-features = nix-command flakes
        show-trace = true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05

      - name: Run Nix lint (statix)
        run: |
          set -euo pipefail
          set -x
          nix run --print-build-logs nixpkgs#statix -- check .

      - name: Check Nix formatting
        run: |
          set -euo pipefail
          set -x
          mapfile -t nix_files < <(find . -name "*.nix" -type f | sort)
          if [ ${#nix_files[@]} -eq 0 ]; then
            echo "No Nix files found"
            exit 0
          fi

          echo "Checking formatting for ${#nix_files[@]} files:" "${nix_files[@]}"
          nix run --print-build-logs nixpkgs#nixpkgs-fmt -- --check "${nix_files[@]}"

  kube-linter:
    runs-on: ubuntu-latest
    needs:
      - nix-flake-check
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          set -euo pipefail
          KUSTOMIZE_URL="https://github.com/kubernetes-sigs/kustomize/releases"
          KUSTOMIZE_URL+="/download/"
          KUSTOMIZE_URL+="kustomize%2Fv${KUSTOMIZE_VERSION}/"
          KUSTOMIZE_URL+="kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          curl -Lo kustomize.tar.gz "$KUSTOMIZE_URL"
          tar -xzvf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin

      - name: Install kube-linter
        run: |
          set -euo pipefail
          KUBE_LINTER_URL="https://github.com/stackrox/kube-linter/releases"
          KUBE_LINTER_URL+="/download/v${KUBE_LINTER_VERSION}/"
          KUBE_LINTER_URL+="kube-linter-linux.tar.gz"
          curl -L "$KUBE_LINTER_URL" | tar -xz
          sudo mv kube-linter /usr/local/bin/

      - name: Run kube-linter on manifests
        run: |
          set -euo pipefail

          # Cr√©er un fichier de configuration kube-linter
          cat > .kube-linter.yaml << 'EOF'
          checks:
            # Utiliser les checks par d√©faut
            # et exclure ceux probl√©matiques pour un homelab
            doNotAutoAddDefaults: false
            exclude:
              # Acceptable pour certains containers dans un homelab
              - "no-read-only-root-fs"
              # Peut √™tre n√©cessaire pour certains services
              - "run-as-non-root"
              # Pas critique pour un homelab
              - "required-label-owner"
              # Peut √™tre n√©cessaire pour certains services
              - "privileged"
          EOF

          for env in review staging prod; do
            echo "üîç Analysing $env environment with kube-linter..."
            kustomize build "clusters/${env}" > "/tmp/manifests-${env}.yaml"
            kube-linter lint "/tmp/manifests-${env}.yaml" \
              --config .kube-linter.yaml
          done

  trivy-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          set -euo pipefail
          TRIVY_URL="https://github.com/aquasecurity/trivy/releases"
          TRIVY_URL+="/download/v${TRIVY_VERSION}/"
          TRIVY_URL+="trivy_${TRIVY_VERSION}_Linux-64bit.tar.gz"
          curl -L "$TRIVY_URL" | tar -xz
          sudo mv trivy /usr/local/bin/

      - name: Scan repository for vulnerabilities
        run: |
          echo "üîç Scanning repository with Trivy..."
          trivy fs --exit-code 1 --severity HIGH,CRITICAL .

      - name: Scan Docker images (if any)
        run: |
          # Scanner les images Docker mentionn√©es dans les manifests
          if [ -f "Dockerfile" ]; then
            echo "üê≥ Scanning Dockerfile..."
            trivy config --exit-code 1 --severity HIGH,CRITICAL Dockerfile
          fi

          # Scanner les images dans les manifests Kubernetes
          echo "üîç Extracting container images from manifests..."
          find clusters/ -name "*.yaml" -type f | \
            xargs grep -h "image:" | \
            sed 's/.*image: *//g' | sed 's/["'"'"']//g' | sort -u | \
            while read -r image; do
              if [[ "$image" != *"<"* ]] && [[ "$image" != "" ]]; then
                echo "üîç Scanning image: $image"
                trivy image --exit-code 1 \
                  --severity HIGH,CRITICAL "$image" || true
              fi
            done

  trufflehog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Secret scanning (trufflehog)
        uses: trufflesecurity/trufflehog@v3.91.2
        with:
          scanArguments: "--no-update --fail --only-verified --json"

  promote-review:
    runs-on: ubuntu-latest
    needs:
      - kubeconform
      - shellcheck
      - nix-lint
      - kube-linter
      - trivy-scan
      - trufflehog
    environment: review
    steps:
      - name: Await approval for review
        run: echo "Ready to sync review environment via Flux"

  promote-staging:
    runs-on: ubuntu-latest
    needs:
      - promote-review
    environment: staging
    steps:
      - name: Await approval for staging
        run: echo "Ready to promote to staging"

  promote-prod:
    runs-on: ubuntu-latest
    needs:
      - promote-staging
    environment: prod
    steps:
      - name: Await approval for prod
        run: echo "Ready to promote to prod"
