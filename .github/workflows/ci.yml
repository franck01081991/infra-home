---
name: ci

"on":
  pull_request: {}
  push:
    branches:
      - main

jobs:
  nix-flake-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-24.05

      - name: Nix flake check
        run: nix flake check --all-systems

  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install pre-commit
        run: pip install --upgrade pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files --show-diff-on-failure

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: ShellCheck scripts
        run: |
          set -euo pipefail
          find scripts k8s -name '*.sh' -print0 | xargs -0 -r shellcheck

  kubeconform:
    runs-on: ubuntu-latest
    needs:
      - nix-flake-check
      - pre-commit
      - shellcheck
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          set -euo pipefail
          KUSTOMIZE_VERSION="5.3.0"
          curl -Lo kustomize.tar.gz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v${KUSTOMIZE_VERSION}/kustomize_v${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          tar -xzvf kustomize.tar.gz
          sudo mv kustomize /usr/local/bin

      - name: Install kubeconform
        run: |
          set -euo pipefail
          KUBECONFORM_VERSION="v0.6.7"
          KUBECONFORM_URL="https://github.com/yannh/kubeconform/"\
          "releases/download/${KUBECONFORM_VERSION}/"\
          "kubeconform-linux-amd64.tar.gz"
          curl -L "$KUBECONFORM_URL" | tar -xz kubeconform
          sudo mv kubeconform /usr/local/bin/

      - name: Validate manifests with kubeconform
        run: |
          set -euo pipefail
          SKIP_KINDS="CustomResourceDefinition,HelmRepository,HelmRelease"
          SKIP_KINDS="${SKIP_KINDS},GitRepository,Kustomization,Application"
          SKIP_KINDS="${SKIP_KINDS},SecretStore,ExternalSecret"

          for env in review staging prod; do
            kustomize build "clusters/${env}" \
              | kubeconform -strict \
                --skip "${SKIP_KINDS}" \
                --summary;
          done

  helm-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Lint OpenBao chart
        run: |
          set -euo pipefail
          helm repo add openbao \
            https://openbao.github.io/openbao-helm
          helm repo add external-secrets \
            https://charts.external-secrets.io
          helm pull openbao/openbao \
            --untar \
            --untardir /tmp/openbao-chart
          helm lint /tmp/openbao-chart/openbao \
            -f clusters/base/apps/openbao/values.yaml

  trivy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Trivy config scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: clusters
          exit-code: '1'
          severity: 'CRITICAL,HIGH'

  checkov:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Checkov IaC scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: clusters
          quiet: true

  tfsec:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect Terraform files
        id: detect-tf
        run: |
          if git ls-files '*.tf' | grep -q .; then
            echo "has_tf=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_tf=false" >> "$GITHUB_OUTPUT"
          fi

      - name: tfsec
        if: steps.detect-tf.outputs.has_tf == 'true'
        uses: aquasecurity/tfsec-action@v1.0.21

  promote-review:
    runs-on: ubuntu-latest
    needs:
      - kubeconform
      - helm-lint
      - trivy
      - checkov
    environment: review
    steps:
      - name: Await approval for review
        run: echo "Ready to sync review environment via Flux"

  promote-staging:
    runs-on: ubuntu-latest
    needs:
      - promote-review
    environment: staging
    steps:
      - name: Await approval for staging
        run: echo "Ready to promote to staging"

  promote-prod:
    runs-on: ubuntu-latest
    needs:
      - promote-staging
    environment: prod
    steps:
      - name: Await approval for prod
        run: echo "Ready to promote to prod"
